<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Master Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --primary: #2563eb; --secondary: #64748b; 
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: #f1f5f9; padding: 15px; margin: 0; color: #1e293b; 
        }
        
        .container { 
            max-width: 1100px; margin: auto; background: white; 
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        
        .tabs { 
            display: flex; gap: 5px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0;
            overflow-x: auto; white-space: nowrap; scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab { 
            padding: 12px 18px; cursor: pointer; border-bottom: 3px solid transparent; 
            font-weight: 600; color: var(--secondary); transition: 0.3s; flex-shrink: 0;
        }
        .tab.active { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
        
        .view { display: none; }
        .view.active { display: block; }
        .hidden { display: none !important; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .input-group { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #475569; }
        input { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; 
        }

        .card-result { background: #1e293b; color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .big-val { font-size: 2.2rem; font-weight: 800; display: block; color: #38bdf8; }

        .gauge-container { height: 10px; background: #e2e8f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .gauge-bar { height: 100%; width: 0%; transition: 0.5s ease; }

        .info-card { font-size: 0.85rem; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid transparent; line-height: 1.5; }
        .success-bg { background: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .warning-bg { background: #fffbeb; color: #92400e; border-color: #fde68a; }
        .danger-bg { background: #fef2f2; color: #991b1b; border-color: #fecaca; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-top: 10px; font-size: 1rem; }
        .btn-share { background: #38bdf8; color: #1e293b; }
        
        .table-amort { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.85rem; margin-top: 15px; }
        .table-amort th { border-bottom: 2px solid #cbd5e1; padding-bottom: 8px; }
        .table-amort td { padding: 10px 0; border-bottom: 1px solid #e2e8f0; }

        .fav-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); margin-top: 15px; }
        .fav-card { background: white; border: 1px solid var(--primary); padding: 10px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        @media (prefers-color-scheme: dark) {
            body { background: #0f172a; color: #f1f5f9; }
            .container { background: #1e293b; border-color: #334155; }
            .input-group, .fav-card { background: #334155; border-color: #475569; }
            input { background: #1e293b; color: white; border-color: #475569; }
            label, .tab { color: #cbd5e1; }
            .tab.active { background: #334155; }
            .tabs { border-color: #334155; }
            .info-card { background: #1e293b; }
        }

        @media (max-width: 850px) { 
            .grid { grid-template-columns: 1fr; gap: 20px; } 
            body { padding: 0; }
            .container { border-radius: 0; padding: 15px; box-shadow: none; min-height: 100vh; }
            .tabs { position: sticky; top: 0; background: inherit; z-index: 100; padding-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchView('simple', this)">üìä Simulation</div>
        <div class="tab" onclick="switchView('compare', this)">‚öñÔ∏è Comparateur</div>
        <div class="tab" onclick="switchView('capacity', this)">üí∞ Capacit√©</div>
    </div>

    <div id="view-simple" class="view active">
        
        <div id="check-vigilance" class="info-card" style="margin-bottom: 20px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 10px 0; font-size: 0.9rem;">üßê L'avis de ton Coach</h4>
            <ul id="vigilance-list" style="margin: 0; padding-left: 20px; font-size: 0.85rem;"></ul>
        </div>

        <div class="grid">
            <div class="input-group">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Prix de l'objet (‚Ç¨)</label><input type="number" id="s-cap" value="15000" oninput="run()"></div>
                    <div><label>Argent mis de c√¥t√© (‚Ç¨)</label><input type="number" id="s-apport" value="3000" oninput="run()"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Taux du pr√™t (%)</label><input type="number" id="s-rate" value="4.5" step="0.1" oninput="run()"></div>
                    <div><label>Dur√©e (mois)</label><input type="number" id="s-dur" value="48" oninput="run()"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Assurance/Frais (‚Ç¨/m)</label><input type="number" id="s-extra" value="30" oninput="run()"></div>
                    <div><label>Mes revenus nets (‚Ç¨)</label><input type="number" id="s-income" value="2200" oninput="run()"></div>
                </div>
                <hr style="opacity:0.1; margin: 15px 0;">
                <label>Vouloir payer plus par mois (+‚Ç¨)</label>
                <input type="number" id="s-boost" value="0" placeholder="Ex: 50" oninput="run()">
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="s-proj-name" placeholder="Nom du projet (ex: Clio 5)" style="margin-bottom:0;">
                    <button onclick="saveFavorite()" class="btn" style="margin-top:0; width:60px; background:var(--warning); color:white;">‚≠ê</button>
                </div>
                <button onclick="shareLink()" class="btn btn-share" style="margin-top:10px;">üîó Partager ce calcul</button>
            </div>
            
            <div>
                <div class="card-result">
                    <span style="font-size:0.9rem; opacity:0.8;">JE PAYE CHAQUE MOIS :</span>
                    <span class="big-val" id="res-m-total">0 ‚Ç¨</span>
                    <p id="res-detail" style="font-size:0.85rem; margin-top:5px; opacity:0.7;"></p>
                    <p id="res-date-fin" style="font-size:0.9rem; font-weight:bold; color: #38bdf8; margin-top:8px;"></p>
                    <div id="boost-notif" style="color:var(--success); font-weight:bold; font-size:0.85rem; margin-top:5px;"></div>
                </div>
                
                <div class="info-card" id="debt-zone">
                    <div id="gauge-label" style="font-weight:bold;">Poids sur mon budget : 0%</div>
                    <div class="gauge-container"><div id="gauge-bar" class="gauge-bar"></div></div>
                    <div id="debt-msg"></div>
                </div>

                <div style="height: 220px; margin-top: 20px;">
                    <canvas id="chartSimple"></canvas>
                </div>

                <button onclick="document.getElementById('amort-box').classList.toggle('hidden')" class="btn" style="background:#e2e8f0; color:#1e293b; font-size:0.8rem;">üìÖ Calendrier de paiement annuel</button>
                <div id="amort-box" class="hidden" style="overflow-x:auto;">
                    <table class="table-amort">
                        <thead><tr><th>Ann√©e</th><th>Int√©r√™ts</th><th>Capital</th><th>Reste d√ª</th></tr></thead>
                        <tbody id="amort-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="margin-top:30px;">
            <h4 style="margin-bottom:10px;">‚≠ê Mes simulations enregistr√©es</h4>
            <div id="favorites-container" class="fav-grid"></div>
        </div>
    </div>

    <div id="view-compare" class="view">
        <div class="grid">
            <div class="input-group">
                <h3>Option A</h3>
                <label>Emprunt (‚Ç¨)</label><input type="number" id="c1-cap" value="5000" oninput="compare()">
                <label>Taux (%)</label><input type="number" id="c1-rate" value="5" oninput="compare()">
                <label>Dur√©e (mois)</label><input type="number" id="c1-dur" value="12" oninput="compare()">
                <div id="c1-res" style="color:var(--primary); font-weight:bold; font-size: 1.1rem; margin-top: 10px;">--</div>
            </div>
            <div class="input-group" style="border-left: 5px solid var(--primary)">
                <h3>Option B</h3>
                <label>Emprunt (‚Ç¨)</label><input type="number" id="c2-cap" value="5000" oninput="compare()">
                <label>Taux (%)</label><input type="number" id="c2-rate" value="0" oninput="compare()">
                <label>Dur√©e (mois)</label><input type="number" id="c2-dur" value="4" oninput="compare()">
                <div id="c2-res" style="color:var(--primary); font-weight:bold; font-size: 1.1rem; margin-top: 10px;">--</div>
            </div>
        </div>
        <div id="compare-winner" class="card-result" style="margin-top: 20px; background: var(--primary)">Quelle est la meilleure option ?</div>
    </div>

    <div id="view-capacity" class="view">
        <div class="grid">
            <div class="input-group">
                <label>Mensualit√© que je peux payer (‚Ç¨/mois)</label>
                <input type="number" id="cap-m" value="300" oninput="calcCap()">
                <label>Taux de la banque (%)</label>
                <input type="number" id="cap-r" value="4.5" oninput="calcCap()">
                <label>Pendant combien d'ann√©es ?</label>
                <input type="number" id="cap-y" value="5" oninput="calcCap()">
            </div>
            <div class="card-result" style="background: var(--success)">
                <span style="font-size:0.9rem; opacity:0.8;">JE PEUX ACHETER UN OBJET DE :</span>
                <span class="big-val" id="cap-res" style="color: white">0 ‚Ç¨</span>
            </div>
        </div>
    </div>
</div>

<script>
let chartS;

function switchView(viewId, el) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('view-' + viewId).classList.add('active');
    el.classList.add('active');
}

window.onload = () => {
    const saved = JSON.parse(localStorage.getItem('financeProSave'));
    if (saved) {
        document.getElementById('s-cap').value = saved.cap || 15000;
        document.getElementById('s-apport').value = saved.apport || 3000;
        document.getElementById('s-rate').value = saved.rate || 4.5;
        document.getElementById('s-dur').value = saved.dur || 48;
        if(saved.inc) document.getElementById('s-income').value = saved.inc;
    }
    run(); compare(); calcCap(); renderFavorites();
};

function run() {
    const prixTotal = parseFloat(document.getElementById('s-cap').value) || 0;
    const argentDeCote = parseFloat(document.getElementById('s-apport').value) || 0;
    const P = Math.max(0, prixTotal - argentDeCote); // Le montant √† emprunter

    const r_ann = parseFloat(document.getElementById('s-rate').value) / 100;
    const n_base = parseInt(document.getElementById('s-dur').value) || 0;
    const extra = parseFloat(document.getElementById('s-extra').value) || 0;
    const income = parseFloat(document.getElementById('s-income').value) || 0;
    const boost = parseFloat(document.getElementById('s-boost').value) || 0;

    if (n_base <= 0) return;

    const r = r_ann / 12;
    const m_base = r === 0 ? P / n_base : (P * r) / (1 - Math.pow(1 + r, -n_base));
    
    let m_boosted = m_base + boost;
    let n_actual = n_base;
    if (boost > 0 && r > 0) {
        let val = 1 - (P * r) / m_boosted;
        if (val > 0) n_actual = -Math.log(val) / Math.log(1 + r);
    }

    const m_total = m_boosted + extra;
    const total_int = (m_boosted * n_actual) - P;
    const ratio = income > 0 ? (m_total / income) * 100 : 0;

    // Calcul date de fin
    const dateFin = new Date();
    dateFin.setMonth(dateFin.getMonth() + Math.ceil(n_actual));
    const optionsDate = { month: 'long', year: 'numeric' };
    
    document.getElementById('res-m-total').innerText = Math.round(m_total) + " ‚Ç¨";
    document.getElementById('res-detail').innerText = `${Math.round(m_boosted)}‚Ç¨ (pr√™t) + ${extra}‚Ç¨ (frais)`;
    document.getElementById('res-date-fin').innerText = `üèÅ Lib√©r√© de ce pr√™t en ${dateFin.toLocaleDateString('fr-FR', optionsDate)}`;

    // Jauge
    const gBar = document.getElementById('gauge-bar');
    const gZone = document.getElementById('debt-zone');
    document.getElementById('gauge-label').innerText = `Poids sur mon budget : ${ratio.toFixed(1)}%`;
    gBar.style.width = Math.min(ratio, 100) + "%";
    
    if (ratio < 20) { gBar.style.background = "var(--success)"; gZone.className="info-card success-bg"; document.getElementById('debt-msg').innerText="‚úÖ C'est tr√®s raisonnable."; }
    else if (ratio < 33) { gBar.style.background = "var(--warning)"; gZone.className="info-card warning-bg"; document.getElementById('debt-msg').innerText="‚ö†Ô∏è Attention, c'est la limite conseill√©e."; }
    else { gBar.style.background = "var(--danger)"; gZone.className="info-card danger-bg"; document.getElementById('debt-msg').innerText="üö® Danger : trop d'endettement !"; }

    updateVigilance(P, r_ann * 100, n_actual, ratio, total_int, argentDeCote, prixTotal);
    generateAmortization(P, r, m_boosted, n_actual);

    if (boost > 0) document.getElementById('boost-notif').innerText = `üöÄ Gain : -${Math.round(n_base - n_actual)} mois !`;
    else document.getElementById('boost-notif').innerText = "";

    updateChart(argentDeCote, P, total_int, extra * n_actual);
    localStorage.setItem('financeProSave', JSON.stringify({cap: prixTotal, apport: argentDeCote, rate: r_ann*100, dur: n_base, inc: income}));
}

function updateVigilance(P, r_ann_pct, n, ratio, int, apport, prixTotal) {
    const list = document.getElementById('vigilance-list');
    list.innerHTML = "";
    let conseils = [];
    
    if (P === 0) { conseils.push("ü•≥ <b>Bravo !</b> Tu as assez d'argent pour payer cash."); }
    else {
        if (apport >= (prixTotal * 0.2)) conseils.push("üí∞ <b>Super apport :</b> Tu empruntes moins, donc tu payes moins d'int√©r√™ts.");
        if (r_ann_pct > 5) conseils.push("‚ùå <b>Taux √©lev√© :</b> Essaye de n√©gocier en dessous de 5%.");
        if (n > 60) conseils.push("‚ö†Ô∏è <b>Cr√©dit trop long :</b> Plus de 5 ans sur un petit objet, c'est risqu√©.");
        if (int > (P * 0.25)) conseils.push("üí∏ <b>Cr√©dit cher :</b> Les int√©r√™ts co√ªtent plus du quart du prix !");
    }
    
    conseils.forEach(txt => { let li = document.createElement('li'); li.innerHTML = txt; li.style.marginBottom = "5px"; list.appendChild(li); });
}

function generateAmortization(P, r_monthly, monthly_pay, months) {
    const tbody = document.getElementById('amort-body');
    tbody.innerHTML = '';
    let balance = P;
    let yInt = 0; let yPrin = 0;
    for(let i=1; i<=Math.ceil(months); i++) {
        let interest = balance * r_monthly;
        let principal = Math.min(balance, monthly_pay - interest);
        balance -= principal;
        yInt += interest; yPrin += principal;
        if(i % 12 === 0 || i === Math.ceil(months)) {
            tbody.innerHTML += `<tr><td>Ann√©e ${Math.ceil(i/12)}</td><td>${Math.round(yInt)}‚Ç¨</td><td>${Math.round(yPrin)}‚Ç¨</td><td style="font-weight:bold;">${Math.round(Math.max(0, balance))}‚Ç¨</td></tr>`;
            yInt = 0; yPrin = 0;
        }
    }
}

function updateChart(apport, emprunt, int, fees) {
    const ctx = document.getElementById('chartSimple').getContext('2d');
    if (chartS) chartS.destroy();
    chartS = new Chart(ctx, {
        type: 'pie',
        data: { 
            labels: ['Argent √† moi', 'Pr√™t (Capital)', 'Co√ªt Int√©r√™ts', 'Frais'], 
            datasets: [{ data: [apport, emprunt, int, fees], backgroundColor: ['#10b981', '#3b82f6', '#ef4444', '#f59e0b'] }] 
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
}

function saveFavorite() {
    const name = document.getElementById('s-proj-name').value || 'Sans nom';
    const data = {
        id: Date.now(), name: name,
        cap: document.getElementById('s-cap').value,
        apport: document.getElementById('s-apport').value,
        rate: document.getElementById('s-rate').value,
        dur: document.getElementById('s-dur').value,
        extra: document.getElementById('s-extra').value,
        inc: document.getElementById('s-income').value
    };
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    favs.push(data);
    localStorage.setItem('financeFavs', JSON.stringify(favs));
    renderFavorites();
}

function renderFavorites() {
    const container = document.getElementById('favorites-container');
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    container.innerHTML = '';
    favs.forEach(f => {
        container.innerHTML += `
            <div class="fav-card" onclick="loadFavorite(${f.id})">
                <div style="display:flex; justify-content:space-between;">
                    <b style="color:var(--primary);">${f.name}</b>
                    <span onclick="event.stopPropagation(); deleteFavorite(${f.id})" style="color:var(--danger); font-weight:bold;">√ó</span>
                </div>
                <div style="font-size:0.75rem; margin-top:5px; opacity:0.8;">${f.cap}‚Ç¨ (${f.dur} mois)</div>
            </div>`;
    });
}

function loadFavorite(id) {
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    let f = favs.find(x => x.id === id);
    if(f) {
        document.getElementById('s-cap').value = f.cap;
        document.getElementById('s-apport').value = f.apport;
        document.getElementById('s-rate').value = f.rate;
        document.getElementById('s-dur').value = f.dur;
        document.getElementById('s-extra').value = f.extra;
        document.getElementById('s-income').value = f.inc;
        run(); window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function deleteFavorite(id) {
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    localStorage.setItem('financeFavs', JSON.stringify(favs.filter(x => x.id !== id)));
    renderFavorites();
}

function compare() {
    const calc = (p, rate, dur) => {
        const r = (rate/100)/12;
        if (dur <= 0) return {m:0, total:0};
        const m = r === 0 ? p/dur : (p * r) / (1 - Math.pow(1 + r, -dur));
        return { m, total: m * dur };
    };
    const r1 = calc(parseFloat(document.getElementById('c1-cap').value), parseFloat(document.getElementById('c1-rate').value), parseInt(document.getElementById('c1-dur').value));
    const r2 = calc(parseFloat(document.getElementById('c2-cap').value), parseFloat(document.getElementById('c2-rate').value), parseInt(document.getElementById('c2-dur').value));
    document.getElementById('c1-res').innerText = `Total: ${Math.round(r1.total)}‚Ç¨ (${Math.round(r1.m)}‚Ç¨/m)`;
    document.getElementById('c2-res').innerText = `Total: ${Math.round(r2.total)}‚Ç¨ (${Math.round(r2.m)}‚Ç¨/m)`;
    document.getElementById('compare-winner').innerText = r1.total < r2.total ? "L'Option A est moins ch√®re" : "L'Option B est moins ch√®re";
}

function calcCap() {
    const m = parseFloat(document.getElementById('cap-m').value) || 0;
    const r = (parseFloat(document.getElementById('cap-r').value) / 100) / 12;
    const n = (parseFloat(document.getElementById('cap-y').value) || 0) * 12;
    const p = r === 0 ? m * n : m * (1 - Math.pow(1 + r, -n)) / r;
    document.getElementById('cap-res').innerText = Math.round(p).toLocaleString() + " ‚Ç¨";
}

async function shareLink() {
    const url = new URL(window.location.href);
    url.searchParams.set('cap', document.getElementById('s-cap').value);
    url.searchParams.set('rate', document.getElementById('s-rate').value);
    url.searchParams.set('dur', document.getElementById('s-dur').value);
    if (navigator.share) { await navigator.share({ title: 'Simulation Finance', text: 'Regarde ma simulation de pr√™t', url: url.toString() }); } 
    else { await navigator.clipboard.writeText(url.toString()); alert("Lien copi√© !"); }
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log(err)); });
}
</script>
</body>
</html>
