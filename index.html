<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Master - Expert</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --danger: #ef4444; --success: #22c55e; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--secondary); }
        .tab.active { border-color: var(--primary); color: var(--primary); }
        
        .view { display: none; }
        .view.active { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .input-group { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: 600; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }

        .card-result { background: #1e293b; color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .big-val { font-size: 2rem; font-weight: 800; display: block; color: #38bdf8; }

        .btn-share { margin-top:15px; width:100%; padding:12px; background:#38bdf8; border:none; border-radius:8px; cursor:pointer; font-weight:bold; color: #1e293b; transition: 0.2s; }
        .btn-share:hover { background: #0ea5e9; }

        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .inflation-info { margin-top: 15px; padding: 10px; background: #f0fdf4; border-radius: 8px; font-size: 0.85rem; color: #166534; border: 1px solid #bbf7d0; }
        
        @media (max-width: 768px) { .grid, .comparison-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchView('simple')">Simulation Solo</div>
        <div class="tab" onclick="switchView('compare')">Comparateur (A vs B)</div>
        <div class="tab" onclick="switchView('capacity')">Capacit√© d'Achat</div>
    </div>

    <div id="view-simple" class="view active">
        <div class="grid">
            <div class="input-group">
                <label>Montant du pr√™t (‚Ç¨)</label>
                <input type="number" id="s-cap" value="10000" oninput="calcSimple()">
                <label>Taux annuel (%)</label>
                <input type="number" id="s-rate" value="4" step="0.1" oninput="calcSimple()">
                <label>Dur√©e (mois)</label>
                <input type="number" id="s-dur" value="36" oninput="calcSimple()">
                <label>Inflation annuelle estim√©e (%)</label>
                <input type="number" id="s-inf" value="2" oninput="calcSimple()">
                
                <button onclick="shareLink()" class="btn-share">üîó Copier le lien de partage</button>
            </div>
            <div>
                <div class="card-result">
                    <span class="stat-label">Mensualit√©</span>
                    <span class="big-val" id="s-res-m">0 ‚Ç¨</span>
                    <hr style="opacity: 0.2; margin: 15px 0;">
                    <p id="s-res-total">Co√ªt total : 0 ‚Ç¨</p>
                </div>
                <div id="inflation-msg" class="inflation-info"></div>
                <div style="max-height: 250px; margin-top: 20px;">
                    <canvas id="chartSimple"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="view-compare" class="view">
        <div class="comparison-grid">
            <div class="input-group">
                <h3>Option A</h3>
                <label>Montant (‚Ç¨)</label>
                <input type="number" id="c1-cap" value="5000" oninput="compare()">
                <label>Taux (%)</label>
                <input type="number" id="c1-rate" value="5" oninput="compare()">
                <label>Dur√©e (mois)</label>
                <input type="number" id="c1-dur" value="12" oninput="compare()">
                <div id="c1-res" style="font-weight: bold; color: var(--primary);">--</div>
            </div>
            <div class="input-group" style="border-left: 5px solid var(--primary)">
                <h3>Option B</h3>
                <label>Montant (‚Ç¨)</label>
                <input type="number" id="c2-cap" value="5000" oninput="compare()">
                <label>Taux (%)</label>
                <input type="number" id="c2-rate" value="0" oninput="compare()">
                <label>Dur√©e (mois)</label>
                <input type="number" id="c2-dur" value="4" oninput="compare()">
                <div id="c2-res" style="font-weight: bold; color: var(--primary);">--</div>
            </div>
        </div>
        <div id="compare-winner" class="card-result" style="margin-top: 20px; background: var(--primary)">Comparez deux options</div>
    </div>

    <div id="view-capacity" class="view">
        <div class="grid">
            <div class="input-group">
                <label>Mensualit√© Max (‚Ç¨/mois)</label>
                <input type="number" id="cap-m" value="300" oninput="calcCap()">
                <label>Taux de la banque (%)</label>
                <input type="number" id="cap-r" value="4.2" oninput="calcCap()">
                <label>Dur√©e (ann√©es)</label>
                <input type="number" id="cap-y" value="5" oninput="calcCap()">
            </div>
            <div class="card-result" style="background: var(--success)">
                <span class="stat-label">Capacit√© d'emprunt estim√©e :</span>
                <span class="big-val" id="cap-res" style="color: white">0 ‚Ç¨</span>
                <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">Bas√© sur vos mensualit√©s</p>
            </div>
        </div>
    </div>
</div>

<script>
let chartS;

// Chargement initial (URL ou LocalStorage)
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    if (params.has('cap')) {
        document.getElementById('s-cap').value = params.get('cap');
        document.getElementById('s-rate').value = params.get('rate');
        document.getElementById('s-dur').value = params.get('dur');
    } else {
        const saved = JSON.parse(localStorage.getItem('financeSave'));
        if (saved) {
            document.getElementById('s-cap').value = saved.cap;
            document.getElementById('s-rate').value = saved.rate;
            document.getElementById('s-dur').value = saved.dur;
        }
    }
    calcSimple();
    compare();
    calcCap();
};

function switchView(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('view-' + view).classList.add('active');
    event.currentTarget.classList.add('active');
}

function calcSimple() {
    const P = parseFloat(document.getElementById('s-cap').value) || 0;
    const r_annual = parseFloat(document.getElementById('s-rate').value) || 0;
    const r = (r_annual / 100) / 12;
    const n = parseInt(document.getElementById('s-dur').value) || 0;
    const inf_annual = parseFloat(document.getElementById('s-inf').value) || 0;
    const inf_monthly = (inf_annual / 100) / 12;

    if (n <= 0) return;

    const m = r === 0 ? P/n : (P * r) / (1 - Math.pow(1 + r, -n));
    const total = m * n;
    const realValueLast = m / Math.pow(1 + inf_monthly, n);
    
    document.getElementById('s-res-m').innerText = m.toFixed(2) + " ‚Ç¨";
    document.getElementById('s-res-total').innerText = `Total : ${total.toFixed(2)}‚Ç¨ (${(total - P).toFixed(2)}‚Ç¨ d'int√©r√™ts)`;
    document.getElementById('inflation-msg').innerText = `üí° Inflation : votre mensualit√© finale de ${m.toFixed(2)}‚Ç¨ vaudra environ ${realValueLast.toFixed(2)}‚Ç¨ en pouvoir d'achat actuel.`;

    updateChart(P, total - P);
    localStorage.setItem('financeSave', JSON.stringify({cap: P, rate: r_annual, dur: n}));
}

function compare() {
    const calc = (p, rate, dur) => {
        const r = (rate/100)/12;
        if (dur <= 0) return {m:0, total:0};
        const m = r === 0 ? p/dur : (p * r) / (1 - Math.pow(1 + r, -dur));
        return { m, total: m * dur };
    };

    const res1 = calc(parseFloat(document.getElementById('c1-cap').value)||0, parseFloat(document.getElementById('c1-rate').value)||0, parseInt(document.getElementById('c1-dur').value)||0);
    const res2 = calc(parseFloat(document.getElementById('c2-cap').value)||0, parseFloat(document.getElementById('c2-rate').value)||0, parseInt(document.getElementById('c2-dur').value)||0);

    document.getElementById('c1-res').innerHTML = `Total: ${res1.total.toFixed(2)}‚Ç¨ (${res1.m.toFixed(2)}‚Ç¨/m)`;
    document.getElementById('c2-res').innerHTML = `Total: ${res2.total.toFixed(2)}‚Ç¨ (${res2.m.toFixed(2)}‚Ç¨/m)`;

    const diff = Math.abs(res1.total - res2.total).toFixed(2);
    const winner = res1.total < res2.total ? "Option A" : "Option B";
    document.getElementById('compare-winner').innerText = `${winner} est plus avantageuse (√âconomie : ${diff}‚Ç¨)`;
}

function calcCap() {
    const m = parseFloat(document.getElementById('cap-m').value) || 0;
    const r = (parseFloat(document.getElementById('cap-r').value) / 100) / 12;
    const n = (parseFloat(document.getElementById('cap-y').value) || 0) * 12;

    if (n <= 0) return;
    const p = r === 0 ? m * n : m * (1 - Math.pow(1 + r, -n)) / r;
    document.getElementById('cap-res').innerText = Math.floor(p).toLocaleString() + " ‚Ç¨";
}

function updateChart(cap, int) {
    const ctx = document.getElementById('chartSimple').getContext('2d');
    if (chartS) chartS.destroy();
    chartS = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Capital', 'Int√©r√™ts'],
            datasets: [{ data: [cap, int], backgroundColor: ['#2563eb', '#ef4444'] }]
        },
        options: { plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false }
    });
}

function shareLink() {
    const url = new URL(window.location.href);
    url.searchParams.set('cap', document.getElementById('s-cap').value);
    url.searchParams.set('rate', document.getElementById('s-rate').value);
    url.searchParams.set('dur', document.getElementById('s-dur').value);
    navigator.clipboard.writeText(url.toString());
    alert("Lien copi√© ! Vous pouvez maintenant le partager.");
}
</script>
</body>
</html>
