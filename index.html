<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Master Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --primary: #2563eb; --secondary: #64748b; 
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: #f1f5f9; padding: 15px; margin: 0; color: #1e293b; 
        }
        
        .container { 
            max-width: 1100px; margin: auto; background: white; 
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        
        .tabs { 
            display: flex; gap: 5px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0;
            overflow-x: auto; white-space: nowrap; scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab { 
            padding: 12px 18px; cursor: pointer; border-bottom: 3px solid transparent; 
            font-weight: 600; color: var(--secondary); transition: 0.3s; flex-shrink: 0;
        }
        .tab.active { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
        
        .view { display: none; }
        .view.active { display: block; }
        .hidden { display: none !important; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .input-group { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #475569; }
        input { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; 
        }

        .card-result { background: #1e293b; color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .big-val { font-size: 2.2rem; font-weight: 800; display: block; color: #38bdf8; }

        .gauge-container { height: 10px; background: #e2e8f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .gauge-bar { height: 100%; width: 0%; transition: 0.5s ease; }

        .info-card { font-size: 0.85rem; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid transparent; line-height: 1.5; }
        .success-bg { background: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .warning-bg { background: #fffbeb; color: #92400e; border-color: #fde68a; }
        .danger-bg { background: #fef2f2; color: #991b1b; border-color: #fecaca; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-top: 10px; font-size: 1rem; }
        .btn-share { background: #38bdf8; color: #1e293b; }
        .btn-share:hover { background: #0ea5e9; }
        
        .table-amort { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.85rem; margin-top: 15px; }
        .table-amort th { border-bottom: 2px solid #cbd5e1; padding-bottom: 8px; }
        .table-amort td { padding: 10px 0; border-bottom: 1px solid #e2e8f0; }

        .fav-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); margin-top: 15px; }
        .fav-card { background: white; border: 1px solid var(--primary); padding: 10px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        @media (prefers-color-scheme: dark) {
            body { background: #0f172a; color: #f1f5f9; }
            .container { background: #1e293b; border-color: #334155; }
            .input-group, .fav-card { background: #334155; border-color: #475569; }
            input { background: #1e293b; color: white; border-color: #475569; }
            label, .tab { color: #cbd5e1; }
            .tab.active { background: #334155; }
            .tabs { border-color: #334155; }
            .info-card { background: #1e293b; }
            .table-amort td, .table-amort th { border-color: #475569; }
        }

        @media (max-width: 850px) { 
            .grid { grid-template-columns: 1fr; gap: 20px; } 
            body { padding: 0; }
            .container { border-radius: 0; padding: 15px; box-shadow: none; min-height: 100vh; }
            .tabs { position: sticky; top: 0; background: inherit; z-index: 100; padding-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchView('simple', this)">üìä Simulation</div>
        <div class="tab" onclick="switchView('compare', this)">‚öñÔ∏è Comparateur</div>
        <div class="tab" onclick="switchView('capacity', this)">üí∞ Capacit√©</div>
    </div>

    <div id="view-simple" class="view active">
        
        <div id="check-vigilance" class="info-card" style="margin-bottom: 20px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 10px 0; font-size: 0.9rem;">üßê Checklist Coach</h4>
            <ul id="vigilance-list" style="margin: 0; padding-left: 20px; font-size: 0.85rem;"></ul>
        </div>

        <div class="grid">
            <div class="input-group">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Prix total (‚Ç¨)</label><input type="number" id="s-cap" value="15000" oninput="run()"></div>
                    <div><label>Apport (‚Ç¨)</label><input type="number" id="s-apport" value="3000" oninput="run()"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Taux (%)</label><input type="number" id="s-rate" value="4.5" step="0.1" oninput="run()"></div>
                    <div><label>Dur√©e (mois)</label><input type="number" id="s-dur" value="48" oninput="run()"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Assurance (‚Ç¨/m)</label><input type="number" id="s-extra" value="30" oninput="run()"></div>
                    <div><label>Revenus nets</label><input type="number" id="s-income" value="2200" oninput="run()"></div>
                </div>
                <hr style="opacity:0.1; margin: 15px 0;">
                <label>Boost remboursement (+‚Ç¨/mois)</label>
                <input type="number" id="s-boost" value="0" placeholder="Ex: 50" oninput="run()">
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="s-proj-name" placeholder="Nom (ex: Clio 5)" style="margin-bottom:0;">
                    <button onclick="saveFavorite()" class="btn" style="margin-top:0; width:60px; background:var(--warning); color:white;">‚≠ê</button>
                </div>
            </div>
            
            <div>
                <div class="card-result">
                    <span style="font-size:0.9rem; opacity:0.8;">MENSUALIT√â</span>
                    <span class="big-val" id="res-m-total">0 ‚Ç¨</span>
                    <p id="res-detail" style="font-size:0.85rem; margin-top:5px; opacity:0.7;"></p>
                    <p id="res-emprunt" style="font-size:0.85rem; font-weight:bold; color:var(--success); margin-top:5px;"></p>
                    <div id="boost-notif" style="color:var(--success); font-weight:bold; font-size:0.85rem; margin-top:5px;"></div>
                </div>
                
                <div class="info-card" id="debt-zone">
                    <div id="gauge-label" style="font-weight:bold;">Endettement : 0%</div>
                    <div class="gauge-container"><div id="gauge-bar" class="gauge-bar"></div></div>
                    <div id="debt-msg"></div>
                </div>

                <div style="height: 220px; margin-top: 20px;">
                    <canvas id="chartSimple"></canvas>
                </div>

                <button onclick="document.getElementById('amort-box').classList.toggle('hidden')" class="btn" style="background:#e2e8f0; color:#1e293b; font-size:0.9rem;">üìÖ Voir l'amortissement par ann√©e</button>
                <div id="amort-box" class="hidden" style="overflow-x:auto;">
                    <table class="table-amort">
                        <thead><tr><th>Ann√©e</th><th>Int√©r√™ts</th><th>Capital</th><th>Reste d√ª</th></tr></thead>
                        <tbody id="amort-body"></tbody>
                    </table>
                </div>

            </div>
        </div>

        <div style="margin-top:30px;">
            <h4 style="margin-bottom:5px;">‚≠ê Mes Projets Sauvegard√©s</h4>
            <div id="favorites-container" class="fav-grid"></div>
        </div>

    </div>

    <div id="view-compare" class="view">
        <div class="grid">
            <div class="input-group">
                <h3>Option A</h3>
                <label>Emprunt (‚Ç¨)</label><input type="number" id="c1-cap" value="5000" oninput="compare()">
                <label>Taux (%)</label><input type="number" id="c1-rate" value="5" oninput="compare()">
                <label>Dur√©e (mois)</label><input type="number" id="c1-dur" value="12" oninput="compare()">
                <div id="c1-res" style="color:var(--primary); font-weight:bold; font-size: 1.1rem; margin-top: 10px;">--</div>
            </div>
            <div class="input-group" style="border-left: 5px solid var(--primary)">
                <h3>Option B</h3>
                <label>Emprunt (‚Ç¨)</label><input type="number" id="c2-cap" value="5000" oninput="compare()">
                <label>Taux (%)</label><input type="number" id="c2-rate" value="0" oninput="compare()">
                <label>Dur√©e (mois)</label><input type="number" id="c2-dur" value="4" oninput="compare()">
                <div id="c2-res" style="color:var(--primary); font-weight:bold; font-size: 1.1rem; margin-top: 10px;">--</div>
            </div>
        </div>
        <div id="compare-winner" class="card-result" style="margin-top: 20px; background: var(--primary)">Comparez deux options</div>
    </div>

    <div id="view-capacity" class="view">
        <div class="grid">
            <div class="input-group">
                <label>Mensualit√© Max (‚Ç¨/mois)</label>
                <input type="number" id="cap-m" value="300" oninput="calcCap()">
                <label>Taux (%)</label>
                <input type="number" id="cap-r" value="4.5" oninput="calcCap()">
                <label>Dur√©e (ann√©es)</label>
                <input type="number" id="cap-y" value="5" oninput="calcCap()">
            </div>
            <div class="card-result" style="background: var(--success)">
                <span style="font-size:0.9rem; opacity:0.8;">CAPACIT√â D'EMPRUNT</span>
                <span class="big-val" id="cap-res" style="color: white">0 ‚Ç¨</span>
            </div>
        </div>
    </div>
</div>

<script>
let chartS;

function switchView(viewId, el) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('view-' + viewId).classList.add('active');
    el.classList.add('active');
}

window.onload = () => {
    const saved = JSON.parse(localStorage.getItem('financeProSave'));
    if (saved) {
        document.getElementById('s-cap').value = saved.cap || 15000;
        document.getElementById('s-apport').value = saved.apport || 3000;
        document.getElementById('s-rate').value = saved.rate || 4.5;
        document.getElementById('s-dur').value = saved.dur || 48;
        if(saved.inc) document.getElementById('s-income').value = saved.inc;
    }
    run(); compare(); calcCap(); renderFavorites();
};

function run() {
    const prixTotal = parseFloat(document.getElementById('s-cap').value) || 0;
    const apport = parseFloat(document.getElementById('s-apport').value) || 0;
    const P = Math.max(0, prixTotal - apport); // Le montant r√©ellement emprunt√©

    const r_ann = parseFloat(document.getElementById('s-rate').value) / 100;
    const n_base = parseInt(document.getElementById('s-dur').value) || 0;
    const extra = parseFloat(document.getElementById('s-extra').value) || 0;
    const income = parseFloat(document.getElementById('s-income').value) || 0;
    const boost = parseFloat(document.getElementById('s-boost').value) || 0;

    if (n_base <= 0 || P < 0) return;

    const r = r_ann / 12;
    const m_base = r === 0 ? P / n_base : (P * r) / (1 - Math.pow(1 + r, -n_base));
    
    // Logique de remboursement anticip√© (Boost)
    let m_boosted = m_base + boost;
    let n_new = n_base;
    if (boost > 0 && r > 0) {
        let val = 1 - (P * r) / m_boosted;
        if (val > 0) n_new = -Math.log(val) / Math.log(1 + r);
    }

    const m_total = m_boosted + extra;
    const total_int = (m_boosted * n_new) - P;
    const ratio = income > 0 ? (m_total / income) * 100 : 0;

    // Mise √† jour de l'interface
    document.getElementById('res-m-total').innerText = Math.round(m_total) + " ‚Ç¨";
    document.getElementById('res-detail').innerText = `${Math.round(m_boosted)}‚Ç¨ (pr√™t) + ${extra}‚Ç¨ (frais)`;
    document.getElementById('res-emprunt').innerText = `Capital emprunt√© : ${P} ‚Ç¨`;

    // Jauge d'endettement
    const gBar = document.getElementById('gauge-bar');
    const gZone = document.getElementById('debt-zone');
    document.getElementById('gauge-label').innerText = `Endettement : ${ratio.toFixed(1)}%`;
    gBar.style.width = Math.min(ratio, 100) + "%";
    
    if (ratio < 20) { gBar.style.background = "var(--success)"; gZone.className="info-card success-bg"; document.getElementById('debt-msg').innerText="Budget sain."; }
    else if (ratio < 33) { gBar.style.background = "var(--warning)"; gZone.className="info-card warning-bg"; document.getElementById('debt-msg').innerText="Vigilance (limite 33%)."; }
    else { gBar.style.background = "var(--danger)"; gZone.className="info-card danger-bg"; document.getElementById('debt-msg').innerText="Alerte : endettement trop √©lev√© !"; }

    updateVigilance(P, r_ann * 100, n_new, ratio, total_int, extra * n_new, apport, prixTotal);
    
    // G√©n√©ration du tableau d'amortissement
    generateAmortization(P, r, m_boosted, n_new);

    if (boost > 0) document.getElementById('boost-notif').innerText = `üöÄ Gain : -${Math.round(n_base - n_new)} mois de cr√©dit !`;
    else document.getElementById('boost-notif').innerText = "";

    updateChart(apport, P, total_int, extra * n_new);
    localStorage.setItem('financeProSave', JSON.stringify({cap: prixTotal, apport: apport, rate: r_ann*100, dur: n_base, inc: income}));
}

function generateAmortization(P, r_monthly, monthly_pay, months) {
    const tbody = document.getElementById('amort-body');
    tbody.innerHTML = '';
    let balance = P;
    let yearInt = 0; let yearPrin = 0;

    for(let i=1; i<=Math.ceil(months); i++) {
        let interest = balance * r_monthly;
        let principal = monthly_pay - interest;
        if(principal > balance) principal = balance;
        balance -= principal;
        yearInt += interest; yearPrin += principal;

        // On affiche un r√©sum√© par ann√©e pour que ce soit lisible sur mobile
        if(i % 12 === 0 || i === Math.ceil(months)) {
            let year = Math.ceil(i/12);
            tbody.innerHTML += `<tr>
                <td><b>Ann√©e ${year}</b></td>
                <td>${yearInt.toFixed(0)}‚Ç¨</td>
                <td>${yearPrin.toFixed(0)}‚Ç¨</td>
                <td style="color:var(--primary); font-weight:bold;">${Math.max(0, balance).toFixed(0)}‚Ç¨</td>
            </tr>`;
            yearInt = 0; yearPrin = 0;
        }
    }
}

function updateVigilance(P, r_ann_pct, n, ratio, int, totalFees, apport, prixTotal) {
    const list = document.getElementById('vigilance-list');
    if(!list) return;
    list.innerHTML = "";
    let conseils = [];
    
    if (apport >= (prixTotal * 0.2)) conseils.push("üíé <b>Bon apport :</b> Tu finances 20% ou plus toi-m√™me, c'est excellent pour r√©duire le co√ªt du cr√©dit.");
    else if (apport === 0) conseils.push("‚ö†Ô∏è <b>Aucun apport :</b> Emprunter √† 100% co√ªte cher. Es-tu s√ªr de ne pas pouvoir mettre un petit billet ?");

    if (r_ann_pct > 5) conseils.push("‚ùå <b>Taux √©lev√© :</b> Ton taux d√©passe 5%.");
    if (n > 60) conseils.push("‚ö†Ô∏è <b>Dur√©e longue :</b> Beaucoup d'int√©r√™ts sur la dur√©e.");
    if (ratio > 33) conseils.push("üö® <b>Danger budget :</b> Tu d√©passes les 33% d'endettement !");
    
    conseils.forEach(txt => { let li = document.createElement('li'); li.innerHTML = txt; li.style.marginBottom = "5px"; list.appendChild(li); });
}

function updateChart(apport, emprunt, int, fees) {
    const ctx = document.getElementById('chartSimple').getContext('2d');
    if (chartS) chartS.destroy();
    chartS = new Chart(ctx, {
        type: 'doughnut',
        data: { 
            labels: ['Apport', 'Emprunt', 'Int√©r√™ts', 'Frais'], 
            datasets: [{ data: [apport, emprunt, int, fees], backgroundColor: ['#10b981', '#3b82f6', '#ef4444', '#f59e0b'] }] 
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
    });
}

// --- GESTION DES FAVORIS ---
function saveFavorite() {
    const name = document.getElementById('s-proj-name').value || 'Projet sans nom';
    const data = {
        id: Date.now(), name: name,
        cap: document.getElementById('s-cap').value,
        apport: document.getElementById('s-apport').value,
        rate: document.getElementById('s-rate').value,
        dur: document.getElementById('s-dur').value,
        extra: document.getElementById('s-extra').value
    };
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    favs.push(data);
    localStorage.setItem('financeFavs', JSON.stringify(favs));
    document.getElementById('s-proj-name').value = ''; // Reset
    renderFavorites();
}

function renderFavorites() {
    const container = document.getElementById('favorites-container');
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    container.innerHTML = '';
    favs.forEach(f => {
        container.innerHTML += `
            <div class="fav-card" onclick="loadFavorite(${f.id})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="color:var(--primary); font-size:0.9rem;">${f.name}</b>
                    <span onclick="event.stopPropagation(); deleteFavorite(${f.id})" style="color:var(--danger); font-size:1.2rem;">√ó</span>
                </div>
                <div style="font-size:0.8rem; opacity:0.8; margin-top:5px;">Prix: ${f.cap}‚Ç¨ | Apport: ${f.apport}‚Ç¨<br>${f.dur} mois √† ${f.rate}%</div>
            </div>`;
    });
}

function loadFavorite(id) {
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    let f = favs.find(x => x.id === id);
    if(f) {
        document.getElementById('s-cap').value = f.cap;
        document.getElementById('s-apport').value = f.apport;
        document.getElementById('s-rate').value = f.rate;
        document.getElementById('s-dur').value = f.dur;
        document.getElementById('s-extra').value = f.extra;
        run();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function deleteFavorite(id) {
    let favs = JSON.parse(localStorage.getItem('financeFavs')) || [];
    favs = favs.filter(x => x.id !== id);
    localStorage.setItem('financeFavs', JSON.stringify(favs));
    renderFavorites();
}

function compare() { /* ...inchang√©... */ }
function calcCap() { /* ...inchang√©... */ }
async function shareLink() { /* ...inchang√© (partage natif)... */ }

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log(err)); });
}
</script>
</body>
</html>
